<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.meta.crm.core.mapper.CrmCustomerMapper">

    <resultMap type="com.meta.crm.intf.entity.CrmCustomer" id="crmCustomerMap">
        <result property="id" column="id"/>
        <result property="customerName" column="customer_name"/>
        <result property="customerLevel" column="customer_level"/>
        <result property="source" column="source"/>
        <result property="profession" column="profession"/>
        <result property="provinceCode" column="province_code"/>
        <result property="cityCode" column="city_code"/>
        <result property="regionCode" column="region_code"/>
        <result property="companyId" column="company_id"/>
        <result property="address" column="address"/>
        <result property="url" column="url"/>
        <result property="employeeNo" column="employee_no"/>
        <result property="clueId" column="clue_id"/>
        <result property="extInfo" column="ext_info"/>
        <result property="tenantId" column="tenant_id"/>
        <result property="delFlag" column="del_flag"/>
        <result property="createBy" column="create_by"/>
        <result property="createTime" column="create_time"/>
        <result property="updateBy" column="update_by"/>
        <result property="updateTime" column="update_time"/>

        <result property="remark" column="remark"/>
        <result property="businessCount" column="businessCount"/>
    </resultMap>

    <!-- 可根据自己的需求，是否要使用 -->
    <sql id="Base_Column_List">
                    id,                    customer_name,                    customer_level,                    source,                    profession,                    province_code,                    city_code,                    region_code,                  company_id,                    address,                    url,                    employee_no,                    clue_id,                    ext_info,                    tenant_id,                    del_flag,                    create_by,                    create_time,                    update_by,                    update_time,                    remark            </sql>

    <insert id="insertCrmCustomer" parameterType="com.meta.crm.intf.entity.CrmCustomer" useGeneratedKeys="true"
            keyProperty="id">
        INSERT INTO crm_customer
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="id != null">
                id,
            </if>
            <if test="customerName != null">
                customer_name,
            </if>
            <if test="customerLevel != null">
                customer_level,
            </if>
            <if test="source != null">
                source,
            </if>
            <if test="profession != null">
                profession,
            </if>
            <if test="provinceCode != null">
                province_code,
            </if>
            <if test="cityCode != null">
                city_code,
            </if>
            <if test="regionCode != null">
                region_code,
            </if>
            <if test="companyId != null">
                company_id,
            </if>
            <if test="address != null">
                address,
            </if>
            <if test="url != null">
                url,
            </if>
            <if test="employeeNo != null">
                employee_no,
            </if>
            <if test="clueId != null">
                clue_id,
            </if>
            <if test="extInfo != null">
                ext_info,
            </if>
            <if test="tenantId != null">
                tenant_id,
            </if>
            <if test="delFlag != null">
                del_flag,
            </if>
            <if test="createBy != null">
                create_by,
            </if>
            <if test="createTime != null">
                create_time,
            </if>
            <if test="updateBy != null">
                update_by,
            </if>
            <if test="updateTime != null">
                update_time,
            </if>
            <if test="remark != null">
                remark,
            </if>
        </trim>
        VALUE
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="id != null">
                #{id},
            </if>
            <if test="customerName != null">
                #{customerName},
            </if>
            <if test="customerLevel != null">
                #{customerLevel},
            </if>
            <if test="source != null">
                #{source},
            </if>
            <if test="profession != null">
                #{profession},
            </if>
            <if test="provinceCode != null">
                #{provinceCode},
            </if>
            <if test="cityCode != null">
                #{cityCode},
            </if>
            <if test="regionCode != null">
                #{regionCode},
            </if>
            <if test="companyId != null">
                #{companyId},
            </if>
            <if test="address != null">
                #{address},
            </if>
            <if test="url != null">
                #{url},
            </if>
            <if test="employeeNo != null">
                #{employeeNo},
            </if>
            <if test="clueId != null">
                #{clueId},
            </if>
            <if test="extInfo != null">
                #{extInfo},
            </if>
            <if test="tenantId != null">
                #{tenantId},
            </if>
            <if test="delFlag != null">
                #{delFlag},
            </if>
            <if test="createBy != null">
                #{createBy},
            </if>
            <if test="createTime != null">
                #{createTime},
            </if>
            <if test="updateBy != null">
                #{updateBy},
            </if>
            <if test="updateTime != null">
                #{updateTime},
            </if>
            <if test="remark != null">
                #{remark},
            </if>
        </trim>
    </insert>

    <insert id="batchInsertCrmCustomer" parameterType="com.meta.crm.intf.entity.CrmCustomer" useGeneratedKeys="true"
            keyProperty="id">
        INSERT INTO crm_customer
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="id != null">
                id,
            </if>
            <if test="customerName != null">
                customer_name,
            </if>
            <if test="customerLevel != null">
                customer_level,
            </if>
            <if test="source != null">
                source,
            </if>
            <if test="profession != null">
                profession,
            </if>
            <if test="provinceCode != null">
                province_code,
            </if>
            <if test="cityCode != null">
                city_code,
            </if>
            <if test="regionCode != null">
                region_code,
            </if>
            <if test="companyId != null">
                company_id,
            </if>
            <if test="address != null">
                address,
            </if>
            <if test="url != null">
                url,
            </if>
            <if test="employeeNo != null">
                employee_no,
            </if>
            <if test="clueId != null">
                clue_id,
            </if>
            <if test="extInfo != null">
                ext_info,
            </if>
            <if test="tenantId != null">
                tenant_id,
            </if>
            <if test="delFlag != null">
                del_flag,
            </if>
            <if test="createBy != null">
                create_by,
            </if>
            <if test="createTime != null">
                create_time,
            </if>
            <if test="updateBy != null">
                update_by,
            </if>
            <if test="updateTime != null">
                update_time,
            </if>
            <if test="remark != null">
                remark,
            </if>
        </trim>
        VALUES
        <foreach collection="list" separator="," item="crmCustomer">
            <trim prefix="(" suffix=")" suffixOverrides=",">
                <if test="id != null">
                    #{id},
                </if>
                <if test="customerName != null">
                    #{customerName},
                </if>
                <if test="customerLevel != null">
                    #{customerLevel},
                </if>
                <if test="source != null">
                    #{source},
                </if>
                <if test="profession != null">
                    #{profession},
                </if>
                <if test="provinceCode != null">
                    #{provinceCode},
                </if>
                <if test="cityCode != null">
                    #{cityCode},
                </if>
                <if test="regionCode != null">
                    #{regionCode},
                </if>
                <if test="companyId != null">
                    #{companyId},
                </if>
                <if test="address != null">
                    #{address},
                </if>
                <if test="url != null">
                    #{url},
                </if>
                <if test="employeeNo != null">
                    #{employeeNo},
                </if>
                <if test="clueId != null">
                    #{clueId},
                </if>
                <if test="extInfo != null">
                    #{extInfo},
                </if>
                <if test="tenantId != null">
                    #{tenantId},
                </if>
                <if test="delFlag != null">
                    #{delFlag},
                </if>
                <if test="createBy != null">
                    #{createBy},
                </if>
                <if test="createTime != null">
                    #{createTime},
                </if>
                <if test="updateBy != null">
                    #{updateBy},
                </if>
                <if test="updateTime != null">
                    #{updateTime},
                </if>
                <if test="remark != null">
                    #{remark},
                </if>
            </trim>
        </foreach>
    </insert>

    <update id="updateCrmCustomer" parameterType="com.meta.crm.intf.entity.CrmCustomer">
        UPDATE crm_customer
        <set>
            <if test="id != null">
                id = #{id},
            </if>
            <if test="customerName != null">
                customer_name = #{customerName},
            </if>
            <if test="customerLevel != null">
                customer_level = #{customerLevel},
            </if>
            <if test="source != null">
                source = #{source},
            </if>
            <if test="profession != null">
                profession = #{profession},
            </if>
            <if test="provinceCode != null">
                province_code = #{provinceCode},
            </if>
            <if test="cityCode != null">
                city_code = #{cityCode},
            </if>
            <if test="regionCode != null">
                region_code = #{regionCode},
            </if>
            <if test="companyId != null">
                company_id = #{companyId},
            </if>
            <if test="address != null">
                address = #{address},
            </if>
            <if test="url != null">
                url = #{url},
            </if>
            <if test="employeeNo != null">
                employee_no = #{employeeNo},
            </if>
            <if test="clueId != null">
                clue_id = #{clueId},
            </if>
            <if test="extInfo != null">
                ext_info = #{extInfo},
            </if>
            <if test="delFlag != null">
                del_flag = #{delFlag},
            </if>
            <if test="createBy != null">
                create_by = #{createBy},
            </if>
            <if test="createTime != null">
                create_time = #{createTime},
            </if>
            <if test="updateBy != null">
                update_by = #{updateBy},
            </if>
            <if test="updateTime != null">
                update_time = #{updateTime},
            </if>
            <if test="remark != null">
                remark = #{remark},
            </if>
        </set>
        <where>
            1 = 1 and tenant_id = #{tenantId}
            <if test="id != null">
                and id = #{id}
            </if>
            <if test="customerName != null">
                and customer_name = #{customerName}
            </if>
            <if test="customerLevel != null">
                and customer_level = #{customerLevel}
            </if>
            <if test="source != null">
                and source = #{source}
            </if>
            <if test="profession != null">
                and profession = #{profession}
            </if>
            <if test="provinceCode != null">
                and province_code = #{provinceCode}
            </if>
            <if test="cityCode != null">
                and city_code = #{cityCode}
            </if>
            <if test="regionCode != null">
                and region_code = #{regionCode}
            </if>
            <if test="companyId != null">
                and company_id = #{companyId}
            </if>
            <if test="address != null">
                and address = #{address}
            </if>
            <if test="url != null">
                and url = #{url}
            </if>
            <if test="employeeNo != null">
                and employee_no = #{employeeNo}
            </if>
            <if test="clueId != null">
                and clue_id = #{clueId}
            </if>
            <if test="extInfo != null">
                and ext_info = #{extInfo}
            </if>
            <if test="delFlag != null">
                and del_flag = #{delFlag}
            </if>
            <if test="createBy != null">
                and create_by = #{createBy}
            </if>
            <if test="createTime != null">
                and create_time = #{createTime}
            </if>
            <if test="updateBy != null">
                and update_by = #{updateBy}
            </if>
            <if test="updateTime != null">
                and update_time = #{updateTime}
            </if>
            <if test="remark != null">
                and remark = #{remark}
            </if>
        </where>
    </update>

    <update id="updateCrmCustomerByPk" parameterType="com.meta.crm.intf.entity.CrmCustomer">
        UPDATE crm_customer
        <set>
            <if test="id != null">
                id = #{id},
            </if>
            <if test="customerName != null">
                customer_name = #{customerName},
            </if>
            <if test="customerLevel != null">
                customer_level = #{customerLevel},
            </if>
            <if test="source != null">
                source = #{source},
            </if>
            <if test="profession != null">
                profession = #{profession},
            </if>
            <if test="provinceCode != null">
                province_code = #{provinceCode},
            </if>
            <if test="cityCode != null">
                city_code = #{cityCode},
            </if>
            <if test="regionCode != null">
                region_code = #{regionCode},
            </if>
            <if test="companyId != null">
                company_id = #{companyId},
            </if>
            <if test="address != null">
                address = #{address},
            </if>
            <if test="url != null">
                url = #{url},
            </if>
            <if test="employeeNo != null">
                employee_no = #{employeeNo},
            </if>
            <if test="clueId != null">
                clue_id = #{clueId},
            </if>
            <if test="extInfo != null">
                ext_info = #{extInfo},
            </if>
            <if test="delFlag != null">
                del_flag = #{delFlag},
            </if>
            <if test="createBy != null">
                create_by = #{createBy},
            </if>
            <if test="createTime != null">
                create_time = #{createTime},
            </if>
            <if test="updateBy != null">
                update_by = #{updateBy},
            </if>
            <if test="updateTime != null">
                update_time = #{updateTime},
            </if>
            <if test="remark != null">
                remark = #{remark},
            </if>
        </set>
        <where>
            id = #{id}
            and tenant_id = #{tenantId}
        </where>
    </update>

    <select id="listCrmCustomer" parameterType="com.meta.crm.intf.req.ro.CrmCustomerRo"
            resultMap="crmCustomerMap">
        select
        customer.*,
        case when b.businessCount is null then 0 else b.businessCount end as businessCount
        from crm_customer customer
        left join (
        select customer_id, count(*) as businessCount from crm_business where tenant_id = #{tenantId}
        group by customer_id
        ) b on customer.id = b.customer_id
        left join crm_assign assign on customer.id = assign.target_id and assign.target_type = 'customer' and
        assign.tenant_id = #{tenantId}
        <where>
            1 = 1 and customer.del_flag = 0 and customer.tenant_id = #{tenantId}
            <if test="managerId != null">
                and assign.manager_id = #{managerId}
            </if>

            <if test="id != null">
                and customer.id = #{id}
            </if>
            <if test="customerName != null">
                and customer.customer_name like CONCAT('%',#{customerName},'%')
            </if>
            <if test="customerLevel != null">
                and customer.customer_level = #{customerLevel}
            </if>
            <if test="source != null">
                and customer.source = #{source}
            </if>
            <if test="profession != null">
                and customer.profession = #{profession}
            </if>
            <if test="provinceCode != null">
                and customer.province_code = #{provinceCode}
            </if>
            <if test="cityCode != null">
                and customer.city_code = #{cityCode}
            </if>
            <if test="regionCode != null">
                and customer.region_code = #{regionCode}
            </if>
            <if test="companyId != null">
                and customer.company_id = #{companyId}
            </if>
            <if test="address != null">
                and customer.address = #{address}
            </if>
            <if test="url != null">
                and customer.url = #{url}
            </if>
            <if test="employeeNo != null">
                and customer.employee_no = #{employeeNo}
            </if>
            <if test="clueId != null">
                and customer.clue_id = #{clueId}
            </if>
            <if test="extInfo != null">
                and customer.ext_info = #{extInfo}
            </if>

            <if test="createBy != null">
                and customer.create_by = #{createBy}
            </if>

            <if test="updateBy != null">
                and customer.update_by = #{updateBy}
            </if>

            <if test="remark != null">
                and customer.remark = #{remark}
            </if>
            <if test="hasBusiness != null and hasBusiness == 0">
                and (b.businessCount is null or b.businessCount = 0)
            </if>
            <if test="hasBusiness != null and hasBusiness == 1">
                and b.businessCount > 0
            </if>

            <if test="startDate != null">
                and <![CDATA[ customer.create_time >= #{startDate} ]]>
            </if>
            <if test="endDate != null">
                and <![CDATA[ customer.create_time <= #{endDate} ]]>
            </if>
            <if test="ids != null">
                and customer.id in
                <foreach collection="ids" index="index" item="item" open="(" separator="," close=")">
                 #{item}
                </foreach>
            </if>
        </where>
        order by customer.create_time desc
    </select>

    <select id="getById" parameterType="com.meta.crm.intf.req.ro.CrmCustomerRo" resultMap="crmCustomerMap">
        select
        <include refid="Base_Column_List"/>
        from crm_customer
        <where>
            id = #{id}
            and tenant_id = #{tenantId}
        </where>
    </select>

    <select id="getByName" parameterType="com.meta.crm.intf.req.ro.CrmCustomerRo" resultMap="crmCustomerMap">
        select
        <include refid="Base_Column_List"/>
        from crm_customer
        <where>
            customer_name = #{customerName}
            and tenant_id = #{tenantId}
        </where>
    </select>

</mapper>
